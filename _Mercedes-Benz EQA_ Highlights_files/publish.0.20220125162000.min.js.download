'use strict';

(function(window, document) {

    const selector = 'cmm-cookie-banner';

    const findData = () => {
        const tags = document.getElementsByTagName(selector);
        const tag = tags.length ? tags[0] : null;

        return tag?.dataset || {};
    };

    const getTrimmedOrDefault = (value) => {
        return (value || '').trim();
    };

    const findLanguageCandidates = () => {
        const data = findData();
        const currentLanguage = getTrimmedOrDefault(data.language);
        const currentMarket = getTrimmedOrDefault(data.market).toLowerCase();
        const candidates = currentLanguage.length ? [currentLanguage] : [];
        if (currentMarket.length) {
            candidates.unshift(currentLanguage + '_' + currentMarket);
        }

        return candidates;
    };

    const changeLanguage = language => {
        window.UC?.changeLanguage(language).then(() => {
            const event = new CustomEvent('page-change-language', {
                bubbles: true,
                language,
            });
            document.dispatchEvent(event);
        });
    };

    const tryChangeLanguage = (candidates, availableLanguages) => {
        const language = candidates.find(p => availableLanguages.includes(p));
        if (language) {
            changeLanguage(language);
        }
    }

    document.addEventListener('usercentrics-consents-loaded', () => {
        const candidates = findLanguageCandidates();

        const languageSettings = UC.getSettings()?.ui?.language;
        const selectedLanguage = languageSettings?.selected;
        const availableLanguages = languageSettings?.available;

        if (!candidates.includes(selectedLanguage)) {
            tryChangeLanguage(candidates, availableLanguages)
        }
    });

}(window, document));
